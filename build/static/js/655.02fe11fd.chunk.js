"use strict";(self.webpackChunkmern_media_web_app=self.webpackChunkmern_media_web_app||[]).push([[655],{1655:function(e,n,t){t.r(n),t.d(n,{default:function(){return S}});var r=t(4165),s=t(5861),o=t(1413),i=t(885),c=t(2791),a=t(364),u=t(1523),l=t(7361),d=t(6953),v=t(184);var f=function(e){var n,t,a=e.conversation,u=e.currentUser,f=e.isActive,m=e.onSelect,x=(0,c.useState)({}),h=(0,i.Z)(x,2),p=h[0],Z=h[1];return(0,c.useEffect)((function(){var e=a.members.find((function(e){return e!==u.userId}));(0,s.Z)((0,r.Z)().mark((function n(){var t,s;return(0,r.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,d.F.get("/users",{params:{userId:e}});case 3:t=n.sent,null!==(s=t.data)&&void 0!==s&&s.response&&Z(s.response),n.next=11;break;case 8:n.prev=8,n.t0=n.catch(0),console.log(n.t0);case 11:case"end":return n.stop()}}),n,null,[[0,8]])})))()}),[u]),(0,v.jsxs)("div",{onClick:function(){return m((0,o.Z)((0,o.Z)((0,o.Z)({},p),a),{},{userId:null===p||void 0===p?void 0:p._id}))},className:"flex items-center p-2.5 cursor-pointer hover:bg-gray-30 ".concat(f&&"bg-gray-20"),children:[(0,v.jsx)("img",{className:"w-10 h-10 object-cover mr-5 rounded-full",src:(null===p||void 0===p?void 0:p.profilepicture)||l.tU,alt:""}),(0,v.jsxs)("div",{className:"font-medium",children:[(0,v.jsx)("div",{children:null===p||void 0===p?void 0:p.username}),(0,v.jsx)("div",{className:"truncate w-40 text-xs",children:(n=a,t=u._id,null!==n&&void 0!==n&&n.text?(null===n||void 0===n?void 0:n.sender)===t?"You: ".concat(null===n||void 0===n?void 0:n.text):null===n||void 0===n?void 0:n.text:"")})]})]})},m=t(3436),x=t(2982),h=t(3877),p=t(2426),Z=t.n(p),g=(0,t(8499).Z)(c.createElement("path",{d:"M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"}),"Done");function b(e){var n,t=e.message,r=e.own,s=e.showSent,o=(0,c.useState)(!1),a=(0,i.Z)(o,2),u=a[0],l=a[1];return(0,c.useEffect)((function(){s&&t.promise.then((function(e){var n;return null===e||void 0===e||null===(n=e.response)||void 0===n?void 0:n.sent})).then(l)}),[]),(0,v.jsx)("div",{className:"flex flex-col ".concat(r&&"items-end"," mt-2"),children:(0,v.jsx)("div",{className:"max-w-xs flex",children:(0,v.jsxs)("div",{className:"px-2.5 py-1 rounded relative ".concat(r?"bg-blue-10 text-white":"bg-gray-50"),children:[(0,v.jsx)("div",{className:"text-xs",children:(n=null===t||void 0===t?void 0:t.createdAt,(new Date).toLocaleDateString()===new Date(n).toLocaleDateString()?Z()(n).format("hh:mm a"):Z()(n).format("DD-MM-YYYY hh:mm a"))}),(0,v.jsx)("div",{className:"md:text-base text-sm break-all mr-3.5",children:null===t||void 0===t?void 0:t.text}),s&&u&&(0,v.jsx)("div",{className:"text-[14px] absolute text-white bottom-0.5 right-2",children:(0,v.jsx)(g,{fontSize:"inherit"})})]})})})}var w=(0,c.memo)(b),j=t(5867),k=t(4860),N=function(e){var n=e.onSubmit,t=(0,c.useState)(""),r=(0,i.Z)(t,2),s=r[0],o=r[1],a=function(e){e.preventDefault(),n(s),o("")};return(0,v.jsxs)("form",{onSubmit:a,className:"px-4 mb-3 flex gap-3 h-14",children:[(0,v.jsx)("input",{className:"h-full flex-grow outline-1 outline outline-gray-100 rounded-2xl px-5",placeholder:"Message...",onChange:function(e){return o(e.target.value)},value:s}),(0,v.jsx)("button",{type:"submit",className:"h-full w-20 text-white bg-blue-30 rounded-3xl grid place-content-center",onClick:a,children:(0,v.jsx)(k.Z,{})})]})};var _=function(e){var n=e.onClose,t=e.currentChat,a=e.user,f=e.receiverId,m=e.incomingMessage,p=e.onSent,Z=e.socket,g=(0,c.useState)(!1),b=(0,i.Z)(g,2),k=b[0],_=b[1],I=(0,c.useState)([]),S=(0,i.Z)(I,2),y=S[0],D=S[1],E=(0,c.useState)({status:!1,lastSeen:0}),C=(0,i.Z)(E,2),L=C[0],M=C[1],R=(0,c.useState)(!0),U=(0,i.Z)(R,2),z=U[0],A=U[1],F=function(e){var n=(0,c.useRef)();return(0,c.useEffect)((function(){n.current=e})),n.current}(null===t||void 0===t?void 0:t._id),Y=(0,c.useRef)(null),G=(0,c.useRef)(null),O=(0,c.useRef)({total:0,page:0,loading:!0,conversationId:null===t||void 0===t?void 0:t._id,receiverId:f}),B=function(e){O.current=(0,o.Z)((0,o.Z)({},O.current),e)};(0,c.useEffect)((function(){window.chatId=null===t||void 0===t?void 0:t._id,B({conversationId:null===t||void 0===t?void 0:t._id,receiverId:f})}),[null===t||void 0===t?void 0:t._id,f]);var H=(0,c.useRef)(0),P=(0,c.useRef)(0),T=function(){var e=(0,s.Z)((0,r.Z)().mark((function e(n){var t,s,o,i;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,q(!0),e.next=4,d.t.get("/messages",{params:n});case 4:return t=e.sent,s=t.data,o=s.data,i=s.total,e.abrupt("return",[o,i]);case 11:e.prev=11,e.t0=e.catch(0),console.error("fetchMessages:- ",e.t0);case 14:return e.prev=14,q(!1),e.finish(14);case 17:case"end":return e.stop()}}),e,null,[[0,11,14,17]])})));return function(n){return e.apply(this,arguments)}}();(0,c.useEffect)((function(){(0,s.Z)((0,r.Z)().mark((function e(){var n,s,o,c;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(F||"")!==(null===t||void 0===t?void 0:t._id)&&(D([]),P.current=0,H.current=0),e.next=3,T({skip:P.current,limit:30,conversationId:null===t||void 0===t?void 0:t._id});case 3:n=e.sent,s=(0,i.Z)(n,2),o=s[0],c=s[1],H.current=c,D(o);case 9:case"end":return e.stop()}}),e)})))()}),[null===t||void 0===t?void 0:t._id]);var V=function(){var e=(0,s.Z)((0,r.Z)().mark((function e(){var n,t,s;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,T({skip:P.current,limit:30,conversationId:O.current.conversationId});case 2:n=e.sent,t=(0,i.Z)(n,1),s=t[0],D((function(e){return[].concat((0,x.Z)(e),(0,x.Z)(s))}));case 6:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),$=(0,c.useCallback)((function(e){if((0,i.Z)(e,1)[0].isIntersecting&&!O.current.loading){var n=P.current;H.current!==n&&(P.current=n+1,V())}}),[]);(0,c.useEffect)((function(){var e=new IntersectionObserver($,{root:null,rootMargin:"30px",threshold:0});return Y.current&&e.observe(Y.current),function(){Y.current&&e.unobserve(Y.current)}}),[$]),(0,c.useEffect)((function(){Object.keys(m).length&&D((function(e){return[(0,o.Z)((0,o.Z)({},m),{},{_id:Date.now(),conversationId:t._id})].concat((0,x.Z)(e))}))}),[m]),(0,c.useEffect)((function(){return Z.connected&&(Z.on("user_disconnect",(function(e){var n=O.current.receiverId,t=e.offline===n;M({status:t,lastSeen:Date.now()}),t&&_(!1)})),Z.on("user_status",(function(e){e.online===O.current.receiverId&&_(!0)}))),function(){null!==Z&&void 0!==Z&&Z.connected&&Z.off("user_disconnect")}}),[Z.connected]);var q=function(e){A(e),B({loading:e})};(0,c.useEffect)((function(){if(null!==t&&void 0!==t&&t._id)return(0,s.Z)((0,r.Z)().mark((function e(){return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:try{Z.emit("user_status",{id:f},(function(e){var n=e.response;_(null===n||void 0===n?void 0:n.online)}))}catch(n){console.log(n)}case 1:case"end":return e.stop()}}),e)})))(),function(){return Z.emit("remove_tracker",{id:f},(function(){}))}}),[null===t||void 0===t?void 0:t._id,Z.connected]);var J=function(e){return new Promise((function(n){Z.connected?Z.emit("message",e,n):n({response:{sent:!1}})}))},K=function(){var e=(0,s.Z)((0,r.Z)().mark((function e(n){var s,i,c;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.trim()){e.next=2;break}return e.abrupt("return");case 2:return i={sender:a.userId,text:n,conversationId:t._id,createdAt:Date.now(),receiver:f},p(i),null===(s=G.current)||void 0===s||s.scrollIntoView({behavior:"smooth",block:"start"}),c=J((0,o.Z)((0,o.Z)({},i),{},{profilepicture:null===a||void 0===a?void 0:a.profilepicture,username:null===a||void 0===a?void 0:a.username})),e.prev=6,D((function(e){return[(0,o.Z)((0,o.Z)({},i),{},{_id:Date.now(),promise:c})].concat((0,x.Z)(e))})),e.next=10,d.t.post("/messages",i);case 10:e.next=15;break;case 12:e.prev=12,e.t0=e.catch(6),console.log(e.t0);case 15:case"end":return e.stop()}}),e,null,[[6,12]])})));return function(n){return e.apply(this,arguments)}}(),Q=function(e){var n;return(null===e||void 0===e?void 0:e.sender)===(null===a||void 0===a?void 0:a.userId)&&!(null===e||void 0===e||!e.promise)&&(null===y||void 0===y||null===(n=y[0])||void 0===n?void 0:n._id)===(null===e||void 0===e?void 0:e._id)};return(0,v.jsxs)(v.Fragment,{children:[t&&(0,v.jsxs)("div",{className:"flex items-center md:px-5 px-2 py-1.5 bg-gray-20",children:[(0,v.jsx)("button",{className:"px-1.5",children:(0,v.jsx)(h.Z,{onClick:n})}),(0,v.jsxs)(u.rU,{className:"flex gap-4 items-center",to:"/profile/".concat(null===t||void 0===t?void 0:t.userId),children:[(0,v.jsx)("img",{className:"w-10 h-10 object-cover rounded-full",src:(null===t||void 0===t?void 0:t.profilepicture)||l.tU,alt:""}),(0,v.jsxs)("div",{className:"font-medium",children:[(0,v.jsx)("div",{className:"md:text-lg font-semibold text-base",children:null===t||void 0===t?void 0:t.username}),(0,v.jsx)("div",{className:"md:text-sm text-xs",children:k?"online":"Last seen ".concat(L.status?j.Z.formatDate(null===L||void 0===L?void 0:L.lastSeen):j.Z.formatDate(null===t||void 0===t?void 0:t.lastSeen))})]})]})]}),z&&(0,v.jsx)("div",{className:"h-10 w-10 absolute top-20 right-0 left-0 mx-auto shadow-md p-1 rounded-full",children:(0,v.jsx)("div",{className:"circle-loader"})}),(0,v.jsxs)("div",{className:"h-full overflow-y-auto px-3.5 pt-6 custom-scrollbar flex flex-col-reverse",children:[(0,v.jsx)("div",{className:"mt-6",ref:G}),y.map((function(e){return(0,v.jsx)("div",{className:"px-4",children:(0,v.jsx)(w,{showSent:Q(e),message:e,own:e.sender===a.userId})},e._id)})),(0,v.jsx)("div",{ref:Y}),(0,v.jsx)("div",{className:"text-center rounded bg-white text-xs mb-auto text-darkGray-20 border py-2.5 border-gray-120 mx-10",children:"Do not share any personal information in chat because I'm watching you"})]}),(0,v.jsx)(N,{onSubmit:K})]})},I=t(9106);var S=(0,a.$j)((function(e){return{socket:e.socket.socket,user:e.user}}))((function(e){var n=e.socket,t=e.user,a=(0,c.useState)([]),x=(0,i.Z)(a,2),h=x[0],p=x[1],Z=(0,c.useState)(null),g=(0,i.Z)(Z,2),b=g[0],w=g[1],j=(0,c.useState)(!0),k=(0,i.Z)(j,2),N=k[0],S=k[1],y=(0,c.useState)({}),D=(0,i.Z)(y,2),E=D[0],C=D[1],L=(0,c.useRef)(null);(0,c.useEffect)((function(){document.title="".concat(l.iC," | Chat")}),[]);var M=function(e){var n=e.conversationId,t=e.text,r=e.sender;p((function(e){return e.map((function(e){return n===(null===e||void 0===e?void 0:e._id)?(0,o.Z)((0,o.Z)({},e),{},{text:t,sender:r}):e})).sort((function(e,t){return n===(null===e||void 0===e?void 0:e._id)?-1:n===(null===t||void 0===t?void 0:t._id)?1:0}))}))};(0,c.useEffect)((function(){var e=function(e){var n,t=e.detail;M(t),null!==L&&void 0!==L&&null!==(n=L.current)&&void 0!==n&&n.includes(null===t||void 0===t?void 0:t.sender)&&C(t)};return(0,I.Ld)("message",e),function(){(0,I.r1)("message",e)}}),[]),(0,c.useEffect)((function(){(0,s.Z)((0,r.Z)().mark((function e(){var n,s;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return S(!0),e.prev=1,e.next=4,d.t.get("/conversations/"+t.userId);case 4:n=e.sent,s=n.data,p(s),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(1),console.log(e.t0);case 12:return e.prev=12,S(!1),e.finish(12);case 15:case"end":return e.stop()}}),e,null,[[1,9,12,15]])})))()}),[t.userId]);var R=function(e){w(e),L.current=e?null===e||void 0===e?void 0:e.members:[]};return N?(0,v.jsx)(m.Z,{}):h.length?(0,v.jsxs)("div",{className:"flex bg-gray-110 w-full max-w-360 mx-auto",children:[(0,v.jsx)("div",{className:"md:sticky fixed md:block z-10 bg-white overflow-y-auto w-full flex-[3] h-screen-cal-55 custom-scrollbar ".concat(b?"hidden":"block"),children:(0,v.jsx)("div",{className:"h-full",children:h.map((function(e){return(0,v.jsx)(f,{onSelect:R,isActive:(null===e||void 0===e?void 0:e._id)===(null===b||void 0===b?void 0:b._id),conversation:e,currentUser:t},e._id)}))})}),(0,v.jsx)("div",{className:"sticky w-full flex-[7] h-screen-cal-55",children:(0,v.jsx)("div",{className:"flex flex-col justify-between relative w-full h-full",children:b?(0,v.jsx)(_,{user:t,socket:n,incomingMessage:E,onSent:M,receiverId:null===b||void 0===b?void 0:b.members.find((function(e){return e!==t.userId})),currentChat:b,onClose:function(){return R(null)}}):(0,v.jsx)("span",{className:"grid place-content-center h-full text-ft50-60 text-darkGray-20 text-center",children:"Open a conversation to start a chat."})})})]}):(0,v.jsxs)("div",{className:"flex flex-col justify-center mt-32",children:[(0,v.jsx)("div",{className:"m-auto font-bold text-darkGray-10 text-2xl mb-2",children:"No Friends"}),(0,v.jsx)("div",{className:"mx-auto text-[#222222] font-medium",children:"Follow a Friend To Start Conversation"}),(0,v.jsx)(u.rU,{to:"/",className:"text-[#3a8fde] text-lg block underline underline-offset-2 mx-auto mt-1",children:"Go Back"})]})}))},3877:function(e,n,t){var r=t(2791),s=t(8499);n.Z=(0,s.Z)(r.createElement("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"}),"ArrowBack")},4860:function(e,n,t){var r=t(2791),s=t(8499);n.Z=(0,s.Z)(r.createElement("path",{d:"M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"}),"Send")}}]);
//# sourceMappingURL=655.02fe11fd.chunk.js.map